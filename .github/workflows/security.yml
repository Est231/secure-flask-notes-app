name: Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install bandit flask flask-wtf python-dotenv werkzeug

    - name: Run Bandit Security Scan
      id: bandit_scan  # â¬…ï¸ Ð”ÐžÐ‘ÐÐ’Ð¬Ð¢Ð• Ð­Ð¢Ðž - Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
      continue-on-error: true  # â¬…ï¸ Ð”ÐžÐ‘ÐÐ’Ð¬Ð¢Ð• Ð­Ð¢Ðž - Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ñ‚ÑŒ Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…
      run: |
        echo "ðŸ” Starting Bandit security scan..."
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Bandit Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
        bandit -r . -f txt -o bandit-report.txt
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        if grep -q "Severity: HIGH" bandit-report.txt; then
          echo "âŒ CRITICAL: Bandit found HIGH severity vulnerabilities"
          echo "bandit_failed=true" >> $GITHUB_OUTPUT
          exit 1
        elif grep -q "Severity: MEDIUM" bandit-report.txt; then
          echo "âš ï¸ WARNING: Bandit found MEDIUM severity vulnerabilities"
          echo "bandit_failed=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Bandit scan passed - no critical vulnerabilities found"
          echo "bandit_failed=false" >> $GITHUB_OUTPUT
        fi

    - name: Basic security checks
      id: basic_checks  # â¬…ï¸ Ð”ÐžÐ‘ÐÐ’Ð¬Ð¢Ð• Ð­Ð¢Ðž
      run: |
        echo "ðŸ” Running basic security checks..."
        
        # Check for debug mode
        if grep -r "debug=True" . --include="*.py"; then
          echo "âŒ CRITICAL: debug=True found in production code"
          echo "basic_checks_failed=true" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… Basic security checks passed"
        echo "basic_checks_failed=false" >> $GITHUB_OUTPUT

    - name: Fail if critical issues found
      if: steps.bandit_scan.outputs.bandit_failed == 'true' || steps.basic_checks.outputs.basic_checks_failed == 'true'
      run: |
        echo "ðŸš« Security checks failed. Blocking merge..."
        echo "Please fix the security issues above."
        exit 1